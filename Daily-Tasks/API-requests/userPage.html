<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User page</title>
    <link rel="stylesheet" href="API-request.css">
    <link rel="stylesheet" href="utility.css">
</head>
<body>
    <h1 class="text-center p-20">Welcome back <i id="userName"></i></h1>

    <div class="flex p-30 gap-10">
        <form class="create-post form p-20" id="createPostForm">
            <h3 class="text-center">Create Post</h3>
            <input class="input-field on-focus-input border-rounded p-20 m-10 bg-gray text-area" id="postTitle" type="text" placeholder="Title">

            <textarea class="input-field on-focus-input border-rounded p-20 m-10 bg-gray text-area" id="postContent" name="post-content" rows="4" cols="10" placeholder="Add a content"></textarea>

            <button class="btn bg-black white p-10 px-30 m-10" id="createPostBtn">Create</button>
            
        </form>
        <div class="user-container justify-center  container container-border" id="userPostcontainer">
    
        </div>
        
    </div>
    <div class="modal" id="deleteConfirmModal">
        <div class="modal-content">
            <h3>Are you sure you want to delete this post?</h3>
            <div class="modal-actions">
                <button class="btn bg-black white" id="confirmDeleteBtn">Yes, Delete It.</button>
                <button class="btn bg-gray black" id="cancelDeleteBtn">Cancel</button>
            </div>
        </div>
    </div>


    <script>
        const url = new URL(window.location.href);
        const queryParams = new URLSearchParams(url.search);
        const userId = queryParams.get('id');
        const userName = queryParams.get('userName');
        const USER_API_URL = `https://jsonplaceholder.typicode.com/users/${userId}/posts`
        
        let userPostData = JSON.parse(localStorage.getItem('userPostData')) || []


        const userNameHeading = document.querySelector('#userName')
        const userPostcontainer = document.querySelector('#userPostcontainer')
        const createPostBtn = document.querySelector('#createPostBtn')
        const titleInput = document.querySelector('#postTitle')
        const contentInput = document.querySelector('#postContent')
       

 
        
        window.addEventListener('DOMContentLoaded', function(e){
            userNameHeading.innerText = userName;
            //intial render
            if(!userPostData.length){
                console.log('API Called')
                fetchData(USER_API_URL, {method:'GET'}, userPostData)
            }else{
                renderPosts()
            }

        })

        createPostBtn.addEventListener('click', function(e){
            e.preventDefault(); // Prevent page refresh
            const POST_USER_API_URL = `https://jsonplaceholder.typicode.com/users/${userId}/posts`;
            const userPostTitle = titleInput.value
            const userPostContent = contentInput.value

            if(userPostContent && userPostContent){
                console.log({userPostContent, userPostContent})
                const postHeaderObj = {
                    method: 'POST',
                    body: JSON.stringify({
                        title: userPostTitle,
                        body: userPostContent,
                        userId: userId,
                    }),
                    headers: {
                        'Content-type': 'application/json; charset=UTF-8',
                    }
                }

                fetchData(USER_API_URL, postHeaderObj, userPostData)
            }
            titleInput.value = '';
            contentInput.value = '';
             
        })

        async function fetchData(url, optionalObj={}, dataContainer, extraData={}){
            console.log('fetch called')
            let res = await fetch(url, optionalObj)
            let data = await res.json()
            console.log(data)
            console.log(extraData)
            switch(optionalObj.method){
                case 'GET':
                    if(Array.isArray(data)){
                        dataContainer.push(...[...dataContainer ,...data])
                    }
                    renderPosts();
                    break;
                
                case 'POST':
                    userPostData.push(data);
                    userPostcontainer.innerHTML += createUserPostCard(data);
                    break;

                case 'DELETE':
                    if (res.ok) {
                        console.log('Post deleted successfully');
                        userPostData = userPostData.filter(item => item.id != extraData.postId)
                        renderPosts()
                    } else {
                        console.error('Failed to delete post');
                        return { success: false }; // Handle failure
                    }
                    break;
                
                case 'PUT':
                    console.log('Edit Post using Put method Successfull!')
                    break;
                    
                case 'PATCH':
                    console.log('Edit Post using Patch method Successfull!')
                    break;

            }

            localStorage.setItem('userPostData', JSON.stringify(userPostData))
        }

        function renderPosts() {
            userPostcontainer.innerHTML = ''; 
            userPostData.forEach(item => {
                userPostcontainer.innerHTML += createUserPostCard(item);
            });

            // re-attach delete event listeners after re-rendering
            const deleteBtns = document.querySelectorAll('#deletePost');
            deleteBtns.forEach(item => {
                item.addEventListener('click', function(e) {
                    const target = e.target;
                    if (target.closest('.card').dataset.id === target.dataset.id) {


                        showConfirmModal(target.dataset.id);
                    }
                });
            });
        }


        function createUserPostCard(data){
            console.log('called')
            return (
                `
                <div class='card flex flex-col gap-10' id=${data.username} data-id=${data.id}>
                    <p class='flex justify-space-btw'>
                        <span><b>User ID:</b> ${data.userId}</span>
                        <span><b>Post ID:</b> ${data.id}</span>
                    </p>
                    <p><b>Title:</b> ${data.title}</p>
                    <p class="four-line-ellipsis">${data.body}</p>
                    <div class="card-btns flex justify-space-btw justify-self-end">
                        <button class="btn bg-black white px-30" id="editPost" data-id=${data.id}>Edit</button>
                        <button class="btn bg-black white px-30" id="deletePost" data-id=${data.id}>Delete</button>
                    </div>                
                </div>
                `
            )
        }

        function deletePost(postId){
            console.log(postId)
            const DELE_POST_USER_API_URL = `https://jsonplaceholder.typicode.com/users/posts?id=${postId}`;

            const deleteHeaderObj = {
                method: 'DELETE',
                id: postId,
            }

            fetchData(DELE_POST_USER_API_URL, deleteHeaderObj, userPostData, {postId})
        }
        
        function showConfirmModal(postId){
            const modal = document.querySelector("#deleteConfirmModal");
            const confirmDeleteBtn = document.querySelector("#confirmDeleteBtn");
            const cancelDeleteBtn = document.querySelector("#cancelDeleteBtn");
            

            confirmDeleteBtn.addEventListener('click', function(){
                deletePost(postId)
                closeConfirmModal()
            })
            
            cancelDeleteBtn.addEventListener('click', function(){
                confirmFlag = false;
                closeConfirmModal()
            })

            modal.style.display = 'flex';

        }

        function closeConfirmModal(){
            const modal = document.querySelector("#deleteConfirmModal");
            modal.style.display = 'none';
        }
  



    </script>
</body>
</html>