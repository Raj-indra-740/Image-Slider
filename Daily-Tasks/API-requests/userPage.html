<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User page</title>
    <link rel="stylesheet" href="API-request.css">
    <link rel="stylesheet" href="utility.css">
</head>
<body>
    <h1 class="text-center p-20">Welcome back <i id="userName"></i></h1>

    <div class="flex p-30 gap-10">
        <form class="create-post form p-20" id="createPostForm">
            <h3 class="text-center">Create Post</h3>
            <input class="input-field on-focus-input border-rounded p-20 m-10 bg-gray text-area" id="postTitle" type="text" placeholder="Title">

            <textarea class="input-field on-focus-input border-rounded p-20 m-10 bg-gray text-area" id="postContent" name="post-content" rows="4" cols="10" placeholder="Add a content"></textarea>

            <button class="btn bg-black white p-10 px-30 m-10" id="createPostBtn">Create</button>
            
        </form>
        <div class="user-container justify-center  container container-border" id="userPostcontainer">
    
        </div>
    </div>


    <script>
        const url = new URL(window.location.href);
        const queryParams = new URLSearchParams(url.search);
        const userId = queryParams.get('id');
        const userName = queryParams.get('userName');
        const USER_API_URL = `https://jsonplaceholder.typicode.com/users/${userId}/posts`
        
        const userPostData = []


        const userNameHeading = document.querySelector('#userName')
        const userPostcontainer = document.querySelector('#userPostcontainer')
        const createPostBtn = document.querySelector('#createPostBtn')
        const titleInput = document.querySelector('#postTitle')
        const contentInput = document.querySelector('#postContent')

 
        
        window.addEventListener('DOMContentLoaded', function(e){
            userNameHeading.innerText = userName;
            //intial render
            fetchData(USER_API_URL, null, userPostData)
            setTimeout(() => {
                console.log(userPostData)
                userPostData.forEach(item => {
                    userPostcontainer.innerHTML += createUserPostCard(item)
                })
            }, 1000)
        })

        createPostBtn.addEventListener('click', function(e){
            e.preventDefault(); // Prevent page refresh
            const POST_USER_API_URL = `https://jsonplaceholder.typicode.com/users/${userId}/posts`;
            const userPostTitle = titleInput.value
            const userPostContent = contentInput.value

            if(userPostContent && userPostContent){
                console.log({userPostContent, userPostContent})
                const postHeaderObj = {
                    method: 'POST',
                    body: JSON.stringify({
                        title: userPostTitle,
                        body: userPostContent,
                        userId: userId,
                    }),
                    headers: {
                        'Content-type': 'application/json; charset=UTF-8',
                    }
                }

                fetchData(USER_API_URL, postHeaderObj, userPostData)

            }
             
        })

        async function fetchData(url, optionalObj={}, dataContainer){
            console.log('fetch called')
            let res = await fetch(url, optionalObj)
            let data = await res.json()
            console.log(data)
            if(Array.isArray(data)){
                dataContainer.push(...[...dataContainer ,...data])
            }else{
                userPostData.push(data);
                userPostcontainer.innerHTML += createUserPostCard(data);
            }
            localStorage.setItem('userPostData', JSON.stringify(userPostData))
        }



        function createUserPostCard(data){
            console.log('called')
            return (
                `
                <div class='card' id=${data.username} data-id=${data.id}>
                    <p class='flex justify-space-btw'>
                        <span><b>User ID:</b> ${data.userId}</span>
                        <span><b>Post ID:</b> ${data.id}</span>
                    </p>
                    <p><b>Title:</b> ${data.title}</p>
                    <p>${data.body}</p>
                </div>
                
                `
            )
        }

        
  



    </script>
</body>
</html>